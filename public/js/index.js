var app = angular.module('cio', []);
app.controller('user', ['$scope', '$http', function($scope, $http) {
    $scope.submit = function(firstName, lastName, address, company) {
        // quick validation
        company = company || '';
        address = address || '';
        if (!(firstName && lastName)) {
            var error = '<span id=\"error\">First name and last name required. </span><br>';
            $(error).hide().appendTo('#form').fadeIn('slow').delay(1000).fadeOut('slow');
        } else {

        // other validation could go here

        // form and submit request
        var submission = {
            'first': firstName,
            'last': lastName,
            'address': address,
            'company': company
        };

        // IDs are naively generated by combining first and last name
        // If these fields are changed, or a duplicate is attempted, the behavior is to overwrite
        saveUserInfo(submission, $http)
          .then(function(newUserId) {
              return findUserById(newUserId, $http);
          })
          .then(function(userInfo) {
              if(document.getElementById("dbInfo") !== null){
                  document.getElementById("dbInfo").remove();
              }
              var dbInfo = '<div id=\"dbInfo\"><h3>DB Info:</h3><div>First: ' + userInfo.first + '</div><br><div>Last: ' + userInfo.last + '</div><br>' +
              '<div>Address: ' + userInfo.address + '</div><br><div>Company: ' + userInfo.company + '</div><br>';
              $(dbInfo).appendTo(grid);
          });
        }
      };
}]);

/**
 * Function that uses HTTP to invoke RESTful handler on the server to update a document
 * @param  {JSON} userInfo JSON containing all fields of the user
 * @param  {Object} $http  Angular HTTP object
 * @return {id}
 */
function saveUserInfo(userInfo, $http) {
    var url = 'http://localhost:8080/users/';
    return $http({
        method: 'POST',
        url: url,
        headers: {
            'Content-Type': 'application/json'
        },
        data: userInfo
    }).then(function(response) {
        // response contains the ID of the document just inserted
        return response.data;
    }).catch(function(err) {
        console.log(err);
        return;
    });
}

/**
 * Function that uses HTTP to fetch the document in the database to get most recently written data.
 * @param  {string} userId The ID is naive - just the first and last name combined
 * @param  {Object} $http  Angular HTTP object
 * @return {JSON}          User information
 */
function findUserById(userId, $http) {
    var url = 'http://localhost:8080/users/'+userId.id;
    return $http({
        method: 'GET',
        url: url,
        headers: {
            'Content-Type': 'application/json'
        }
    }).then(function(response) {
        // returns all info about the user
        return response.data;
    }).catch(function(err) {
        console.log(err);
        return;
    });
}
